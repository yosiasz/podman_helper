version: "3.8"

#node --require /mnt/c/myapps/apis4grafana/instrumentation.js server.js
#OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318 BEYLA_OTEL_INSECURE_SKIP_VERIFY=true BEYLA_PRINT_TRACES=true BEYLA_OPEN_PORT=4700 sudo -E beyla --config=beyla-config.yaml
services:
  # Service to instrument. Change it to any
  # other container that you want to instrument.
  #nodejs:
    #image: localhost/nodejs_otel
    #network_mode: "service:nodejs"
    #pid: "service:nodejs"
    #ports:
      # Exposes port 14200, forwarding it to container port 4200
    #  - "14200:4200"
    #ulimits:
      #memlock:
        #soft: -1 # Set memlock to unlimited (no soft or hard limit)
        #hard: -1
      #nofile:
        #soft: 65536 # Maximum number of open files for the opensearch user - set to at least 65536
        #hard: 65536      

  beyla:
    image: grafana/beyla:latest
    securityContext:
      runAsUser: 0
      capabilities:
        add:
          - SYS_ADMIN
          - SYS_RESOURCE
          - SYS_PTRACE    
    #pid: "service:nodejs"
    #container: 
    #cap_add:
    #  - SYS_ADMIN
    # If using the above capability fails to instrument your service, remove it
    # and uncomment the line below
    privileged: true
    environment:
      BEYLA_OTEL_INSECURE_SKIP_VERIFY: true
      BEYLA_PRINT_TRACES: true
      #BEYLA_OPEN_PORT defines which app port should be "instrumented" 
      BEYLA_OPEN_PORT: 4700 
      BEYLA_LOG_LEVEL: "DEBUG"
      #BEYLA_PROMETHEUS_PORT: 9090
      #OTEL_EXPORTER_OTLP_ENDPOINT defines the colector
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://localhost:4317" 
      #OTEL_EXPORTER_OTLP_PROTOCOL: grpc