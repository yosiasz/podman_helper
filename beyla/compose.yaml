version: "3.8"

services:
  # Service to instrument. Change it to any
  # other container that you want to instrument.
  nodejs:
    image: localhost/nodejs_otel
    network_mode: "service:nodejs"
    pid: "service:nodejs"
    ports:
      # Exposes port 14200, forwarding it to container port 4200
      - "14200:4200"
    #ulimits:
      #memlock:
        #soft: -1 # Set memlock to unlimited (no soft or hard limit)
        #hard: -1
      #nofile:
        #soft: 65536 # Maximum number of open files for the opensearch user - set to at least 65536
        #hard: 65536      

  autoinstrumenter:
    image: grafana/beyla:latest
    #pid: service:nodejs"
    container: 
    #cap_add:
    #  - SYS_ADMIN
    # If using the above capability fails to instrument your service, remove it
    # and uncomment the line below
    privileged: true
    environment:
      BEYLA_PRINT_TRACES: true
      BEYLA_OPEN_PORT: 14200
      #BEYLA_PROMETHEUS_PORT: 9090
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://localhost:4317" 
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc